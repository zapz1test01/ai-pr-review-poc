name: AI PR Review

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  review:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Get PR Diff
        id: diff
        run: |
          git fetch origin ${{ github.event.pull_request.base.ref }}
          git diff origin/${{ github.event.pull_request.base.ref }}...HEAD > diff.txt

      - name: Call AI Reviewer
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          REVIEW=$(curl https://api.openai.com/v1/chat/completions \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $OPENAI_API_KEY" \
            -d '{
              "model": "gpt-4.1-mini",
              "messages": [
                {"role": "system", "content": "You are a senior developer. Review this code diff and suggest improvements. Mention bugs, security, performance, naming, tests. Then say APPROVE or REQUEST CHANGES."},
                {"role": "user", "content": "'"$(cat diff.txt | sed 's/"/\\"/g')"'"}
              ]
            }' | jq -r '.choices[0].message.content')

          echo "$REVIEW" > review.txt
          echo "Review result:"
          cat review.txt

      - name: Comment on PR
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          recreate: true
          header: AI Review
          message: |
            ${{ steps.review.outputs.review }}
